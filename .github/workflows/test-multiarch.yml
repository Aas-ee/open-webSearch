name: Test Multi-Platform Docker Build

on:
  push:
    branches:
      - '**'  # å…è®¸åœ¨ä»»ä½•åˆ†æ”¯ä¸Šè§¦å‘
    paths:
      - 'Dockerfile'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      test_platforms:
        description: 'Platforms to test (comma separated)'
        required: false
        default: 'linux/amd64,linux/arm64'

jobs:
  test-build:
    runs-on: ubuntu-latest

    # åªåœ¨ç‰¹å®šåˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œå®Œæ•´æµ‹è¯•
    if: contains(github.ref, 'test-multiarch') || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get lowercase repository owner
        id: lowercase
        run: echo "repository_owner_lowercase=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      # ç¬¬ä¸€æ­¥ï¼šä»…æ„å»ºæµ‹è¯•ï¼ˆä¸æ¨é€ï¼‰
      - name: Test Build Only (No Push)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ github.event.inputs.test_platforms || 'linux/amd64,linux/arm64' }}
          push: false
          tags: test/open-web-search:multiarch-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ç¬¬äºŒæ­¥ï¼šå¦‚æœæ„å»ºæˆåŠŸï¼Œæ¨é€æµ‹è¯•é•œåƒ
      - name: Build and Push Test Image
        if: success()
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ github.event.inputs.test_platforms || 'linux/amd64,linux/arm64' }}
          push: true
          tags: |
            ghcr.io/${{ steps.lowercase.outputs.repository_owner_lowercase }}/open-web-search:test-multiarch
            ghcr.io/${{ steps.lowercase.outputs.repository_owner_lowercase }}/open-web-search:test-${{ github.sha }}
          cache-from: type=gha

      # ç¬¬ä¸‰æ­¥ï¼šéªŒè¯é•œåƒä¿¡æ¯
      - name: Inspect Multi-Platform Image
        if: success()
        run: |
          echo "=== Multi-Platform Image Inspection ==="
          docker buildx imagetools inspect ghcr.io/${{ steps.lowercase.outputs.repository_owner_lowercase }}/open-web-search:test-multiarch
          
          echo -e "\n=== Image Manifest ==="
          docker manifest inspect ghcr.io/${{ steps.lowercase.outputs.repository_owner_lowercase }}/open-web-search:test-multiarch || echo "Manifest command not available"

  # ä¿®å¤åçš„ AMD64 æµ‹è¯•
  test-run-amd64:
    needs: test-build
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get lowercase repository owner
        id: lowercase
        run: echo "repository_owner_lowercase=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Test AMD64 Container
        run: |
          echo "Testing AMD64 container..."
          docker pull --platform linux/amd64 ghcr.io/${{ steps.lowercase.outputs.repository_owner_lowercase }}/open-web-search:test-multiarch
          
          # å¯åŠ¨å®¹å™¨ï¼ˆåå°è¿è¡Œï¼Œç»™å®¹å™¨å‘½åï¼‰
          echo "Starting AMD64 container..."
          CONTAINER_ID=$(docker run -d --platform linux/amd64 --name test-amd64-${{ github.run_number }} ghcr.io/${{ steps.lowercase.outputs.repository_owner_lowercase }}/open-web-search:test-multiarch)
          echo "Container ID: $CONTAINER_ID"
          
          # ç­‰å¾…å®¹å™¨å¯åŠ¨
          echo "Waiting for container to start..."
          sleep 15
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          echo "=== Container Status ==="
          docker ps -a
          
          # ä½¿ç”¨ docker inspect è·å–å®¹å™¨çŠ¶æ€ï¼ˆæ›´å¯é ï¼‰
          CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' $CONTAINER_ID)
          echo "Container status: $CONTAINER_STATUS"
          
          # è·å–æ—¥å¿—
          echo "=== Container Logs ==="
          docker logs $CONTAINER_ID
          
          # æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
          if [ "$CONTAINER_STATUS" = "running" ]; then
            echo "âœ… AMD64 container is running successfully!"
          
            # å°è¯•è¿æ¥åˆ°åº”ç”¨ï¼ˆå¯é€‰ï¼‰
            echo "Testing application connectivity..."
            if docker exec $CONTAINER_ID sh -c 'curl -f http://localhost:3000/health' 2>/dev/null || docker exec $CONTAINER_ID sh -c 'nc -z localhost 3000' 2>/dev/null; then
              echo "âœ… Application is responding!"
            else
              echo "â„¹ï¸  Application connectivity test failed, but container is running"
            fi
          
            # æ¸…ç†ï¼šåœæ­¢å¹¶åˆ é™¤å®¹å™¨
            docker stop $CONTAINER_ID
            docker rm $CONTAINER_ID
          else
            echo "âŒ AMD64 container failed to run. Status: $CONTAINER_STATUS"
          
            # è·å–æ›´å¤šè°ƒè¯•ä¿¡æ¯
            EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' $CONTAINER_ID 2>/dev/null || echo "unknown")
            echo "Exit code: $EXIT_CODE"
          
            # æ¸…ç†å¤±è´¥çš„å®¹å™¨
            docker rm $CONTAINER_ID 2>/dev/null || true
            exit 1
          fi

  # ä¿®å¤åçš„ ARM64 æµ‹è¯•
  test-run-arm64:
    needs: test-build
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get lowercase repository owner
        id: lowercase
        run: echo "repository_owner_lowercase=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Test ARM64 Container
        run: |
          echo "Testing ARM64 container..."
          docker pull --platform linux/arm64 ghcr.io/${{ steps.lowercase.outputs.repository_owner_lowercase }}/open-web-search:test-multiarch
          
          # å¯åŠ¨å®¹å™¨ï¼ˆåå°è¿è¡Œï¼Œç»™å®¹å™¨å‘½åï¼‰
          echo "Starting ARM64 container..."
          CONTAINER_ID=$(docker run -d --platform linux/arm64 --name test-arm64-${{ github.run_number }} ghcr.io/${{ steps.lowercase.outputs.repository_owner_lowercase }}/open-web-search:test-multiarch)
          echo "Container ID: $CONTAINER_ID"
          
          # ARM64 æ¨¡æ‹Ÿéœ€è¦æ›´é•¿æ—¶é—´å¯åŠ¨
          echo "Waiting for ARM64 container to start..."
          sleep 20
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          echo "=== Container Status ==="
          docker ps -a
          
          # ä½¿ç”¨ docker inspect è·å–å®¹å™¨çŠ¶æ€ï¼ˆæ›´å¯é ï¼‰
          CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' $CONTAINER_ID)
          echo "Container status: $CONTAINER_STATUS"
          
          # è·å–æ—¥å¿—
          echo "=== Container Logs ==="
          docker logs $CONTAINER_ID
          
          # æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
          if [ "$CONTAINER_STATUS" = "running" ]; then
            echo "âœ… ARM64 container is running successfully!"
          
            # å°è¯•è¿æ¥åˆ°åº”ç”¨ï¼ˆå¯é€‰ï¼‰
            echo "Testing application connectivity..."
            if docker exec $CONTAINER_ID sh -c 'curl -f http://localhost:3000/health' 2>/dev/null || docker exec $CONTAINER_ID sh -c 'nc -z localhost 3000' 2>/dev/null; then
              echo "âœ… Application is responding!"
            else
              echo "â„¹ï¸  Application connectivity test failed, but container is running"
            fi
          
            # æ¸…ç†ï¼šåœæ­¢å¹¶åˆ é™¤å®¹å™¨
            docker stop $CONTAINER_ID
            docker rm $CONTAINER_ID
          else
            echo "âŒ ARM64 container failed to run. Status: $CONTAINER_STATUS"
          
            # è·å–æ›´å¤šè°ƒè¯•ä¿¡æ¯
            EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' $CONTAINER_ID 2>/dev/null || echo "unknown")
            echo "Exit code: $EXIT_CODE"
          
            # æ¸…ç†å¤±è´¥çš„å®¹å™¨
            docker rm $CONTAINER_ID 2>/dev/null || true
            exit 1
          fi

  # æ¸…ç†æµ‹è¯•é•œåƒ
  cleanup:
    needs: [test-run-amd64, test-run-arm64]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Test Results Summary
        run: |
          echo "ğŸ¯ Multi-Platform Docker Test Results"
          echo "=================================="
          
          if [ "${{ needs.test-build.result }}" == "success" ]; then
            echo "âœ… Multi-platform build: SUCCESS"
          else
            echo "âŒ Multi-platform build: FAILED"
          fi
          
          if [ "${{ needs.test-run-amd64.result }}" == "success" ]; then
            echo "âœ… AMD64 container test: SUCCESS"
          else
            echo "âŒ AMD64 container test: FAILED"
          fi
          
          if [ "${{ needs.test-run-arm64.result }}" == "success" ]; then
            echo "âœ… ARM64 container test: SUCCESS"
          else
            echo "âŒ ARM64 container test: FAILED"
          fi
          
          echo ""
          if [ "${{ needs.test-build.result }}" == "success" ] && [ "${{ needs.test-run-amd64.result }}" == "success" ] && [ "${{ needs.test-run-arm64.result }}" == "success" ]; then
            echo "ğŸ‰ All tests passed! Ready to deploy multi-platform support to production."
            echo ""
            echo "Next steps:"
            echo "1. Update your production docker.yml workflow to include multi-platform support"
            echo "2. Test with a real release tag"
          else
            echo "âš ï¸  Some tests failed. Please check the logs and fix issues before deploying."
          fi

      - name: Cleanup Instructions
        continue-on-error: true
        run: |
          echo ""
          echo "ğŸ“ Cleanup Information:"
          echo "Test images created:"
          echo "- ghcr.io/${{ github.repository_owner }}/open-web-search:test-multiarch"
          echo "- ghcr.io/${{ github.repository_owner }}/open-web-search:test-${{ github.sha }}"
          echo ""
          echo "You can manually delete these test images from GitHub Container Registry if needed."
